<script>
  let quiz = [];
  let questionOrder = [];
  let current = 0;
  let mode = 'infinite';
  let errorCount = 0;
  let usedQuestions = [];
  let questionOrderMode = 'random';

  const fileInput = document.getElementById('fileInput');
  const quizContainer = document.getElementById('quizContainer');
  const qText = document.getElementById('qText');
  const optionsDiv = document.getElementById('options');
  const checkBtn = document.getElementById('checkBtn');
  const feedback = document.getElementById('feedback');
  const errorCountDisplay = document.getElementById('errorCount');

  function shuffleArray(array) {
    return array.map(value => ({ value, sort: Math.random() }))
                .sort((a, b) => a.sort - b.sort)
                .map(({ value }) => value);
  }

  fileInput.addEventListener('change', () => {
    const file = fileInput.files[0];
    if (!file) return;

    readXlsxFile(file).then(rows => {
      quiz = rows.slice(1).map(r => ({
        question: r[0],
        options: [r[1], r[2], r[3]].filter(Boolean),
        correct: r[4] ? r[4].split(/[ ,]+/).map(s => s.trim().toUpperCase()) : []
      }));

      resetAll();
      quizContainer.style.display = '';
    });
  });

  function switchMode(selectedMode) {
    mode = selectedMode;
    resetAll();
  }

  function switchQuestionOrder(selectedOrder) {
    questionOrderMode = selectedOrder;
    resetAll();
  }

  function resetAll() {
    errorCount = 0;
    errorCountDisplay.textContent = errorCount;

    usedQuestions = [];
    questionOrder = questionOrderMode === 'sequential'
      ? [...Array(quiz.length).keys()]
      : shuffleArray([...Array(quiz.length).keys()]);

    current = 0;
    feedback.textContent = '';
    checkBtn.disabled = false;
    showQuestion();
  }

  function showQuestion() {
    feedback.textContent = '';
    optionsDiv.innerHTML = '';

    if (quiz.length === 0) return;

    let questionIndex;

    if (questionOrderMode === 'sequential') {
      if (current >= questionOrder.length) {
        qText.innerText = 'ğŸ‰ Test dokonÄen!';
        checkBtn.disabled = true;
        return;
      }
      questionIndex = questionOrder[current];
    } else {
      const unused = quiz.map((_, i) => i).filter(i => !usedQuestions.includes(i));
      questionIndex = unused.length === 0
        ? Math.floor(Math.random() * quiz.length)
        : unused[Math.floor(Math.random() * unused.length)];
      usedQuestions.push(questionIndex);
    }

    const item = quiz[questionIndex];
    qText.innerText = item.question;

    const labeledOptions = item.options.map((text, i) => ({
      label: String.fromCharCode(65 + i),
      text: text
    }));

    const shuffled = shuffleArray(labeledOptions);
    item.shuffledOptions = shuffled;

    shuffled.forEach((opt, idx) => {
      const id = `option-${current}-${idx}`;

      const wrapper = document.createElement('div');
      wrapper.className = 'option';

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.value = opt.label;
      checkbox.id = id;

      const label = document.createElement('label');
      label.setAttribute('for', id);
      label.textContent = opt.text;

      wrapper.appendChild(checkbox);
      wrapper.appendChild(label);
      optionsDiv.appendChild(wrapper);
    });

    checkBtn.onclick = () => {
      const selected = Array.from(optionsDiv.querySelectorAll('input:checked')).map(cb => cb.value);
      const correct = item.correct;

      const isCorrect = selected.length === correct.length &&
                        selected.every(val => correct.includes(val)) &&
                        correct.every(val => selected.includes(val));

      if (isCorrect) {
        feedback.textContent = 'âœ… SprÃ¡vnÄ›!';
        feedback.className = 'feedback correct';
      } else {
        errorCount++;
        errorCountDisplay.textContent = errorCount;

        const correctTexts = item.shuffledOptions
          .filter(opt => correct.includes(opt.label))
          .map(opt => opt.text);

        feedback.textContent = `âŒ Å patnÄ›. SprÃ¡vnÃ¡ odpovÄ›Ä: ${correctTexts.join(', ')}`;
        feedback.className = 'feedback incorrect';
      }

      current++;
      setTimeout(showQuestion, 2000);
    };
  }
</script>
